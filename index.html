<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat UI</title>
    <link rel="stylesheet" href="styles.css">
    <script src="script.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://kit.fontawesome.com/dda2710b56.js" crossorigin="anonymous"></script>
</head>

<body class="auth-visible">

    <div id="full-page-loader">
        <div class="loader-spinner"></div>
        <p>Loading...</p>
    </div>

    <div id="auth-overlay">
        <div id="auth-container">
            <!-- Login Form -->
            <form id="login-form">
                <h2>Login</h2>
                <div class="auth-form-group">
                    <label for="login-email">Email</label>
                    <input type="email" id="login-email" class="auth-input" required>
                </div>
                <div class="auth-form-group password-group">
                    <label for="login-password">Password</label>
                    <input type="password" id="login-password" class="auth-input" required>
                    <button type="button" class="password-toggle-btn" id="toggle-login-password"><i
                            class="fa-solid fa-eye"></i></button>
                </div>
                <button type="submit" class="auth-button">Login</button>
                <p class="auth-error" id="login-error"></p>
                <p class="auth-toggle">
                    Don't have an account? <button type="button" id="show-signup-btn" class="auth-toggle-btn">Sign
                        Up</button>
                </p>
            </form>

            <!-- Signup Form (hidden by default) -->
            <form id="signup-form" style="display: none;">
                <h2>Sign Up</h2>
                <div class="auth-form-group">
                    <label for="signup-email">Email</label>
                    <input type="email" id="signup-email" class="auth-input" required>
                </div>
                <div class="auth-form-group password-group">
                    <label for="signup-password">Password (min. 6 characters)</label>
                    <input type="password" id="signup-password" class="auth-input" required>
                    <button type="button" class="password-toggle-btn" id="toggle-signup-password"><i
                            class="fa-solid fa-eye"></i></button>
                </div>
                <button type="submit" class="auth-button">Sign Up</button>
                <p class="auth-error" id="signup-error"></p>
                <p class="auth-toggle">
                    Already have an account? <button type="button" id="show-login-btn"
                        class="auth-toggle-btn">Login</button>
                </p>
            </form>
        </div>
    </div>
    <!-- --- END: Auth Overlay --- -->

    <main class="chat-app">
        <nav class="icon-nav">
            <ul>
                <li><button title="Menu"><i class="fa-solid fa-bars"></i></button></li>
                <li><button title="Profile"><i class="fa-regular fa-user"></i></button></li>
                <li><button title="Messages"><i class="fa-regular fa-message"></i></button></li>
                <li><button title="Settings"><i class="fa-solid fa-gear"></i></button></li>
                <li><button title="Edit"><i class="fa-regular fa-pen-to-square"></i></button></li>
                <li><button title="Sign Out" id="sign-out-btn"><i
                            class="fa-solid fa-arrow-right-from-bracket"></i></button>
                </li>
            </ul>
        </nav>

        <aside class="contacts-panel">
            <header>
                <h2>Chats</h2>
                <span><i class="fa-regular fa-star"></i></span>
            </header>

            <div id="user-info">
                <p>You are logged in as:</p>
                <strong id="user-email-display">...loading...</strong>
            </div>

            <button title="New Chat" id="new-chat-btn" class="contacts-header-btn" disabled>
                <i class="fas fa-plus"></i>
            </button>

            <ul class="contacts-list" id="contacts-list">

            </ul>
        </aside>

        <section class="chat-panel">

            <!-- 1. The Placeholder (visible by default) -->
            <div id="chat-placeholder">
                <i class="fas fa-comments"></i>
                <p>Select a chat</p>
                <small>Click on a contact from the list to see your messages.</small>
            </div>

            <!-- 2. The Chat Window (hidden by default) -->
            <div id="chat-window">
                <header>
                    <!-- These are the new elements our JS is looking for -->
                    <figure class="avatar" id="chat-header-avatar">
                        <!-- Avatar initial will go here -->
                    </figure>
                    <strong id="chat-header-name">...</strong>

                    <!-- This is your existing controls markup -->
                    <div class="chat-controls">
                        <span class="search-icon"><i class="fas fa-search"></i></span>
                        <div class="dropdown-container">
                            <button class="dropdown-toggle" title="More options">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <div class="dropdown-menu">
                                <ul>
                                    <li><button class="dropdown-item" id="clear-chat-btn">Clear chat</button></li>
                                    <li><button class="dropdown-item" id="export-chat-btn">Export chat</button></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </header>

                <main class="messages-area" id="messages-area">
                    <!-- Messages will be loaded here by JavaScript -->
                </main>

                <footer>
                    <button title="Attachments">
                        <i class="fas fa-paperclip"></i>
                    </button>
                    <form id="message-form">
                        <input type="text" id="message-input" placeholder="Type a message..." autocomplete="off"
                            disabled>
                        <button type="submit" title="Send Message" disabled>
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </form>
                </footer>
            </div>

        </section>

    </main>

    <!-- --- START: New Chat Modal --- -->
    <div id="new-chat-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Start a New Chat</h3>
                <button id="close-modal-btn" class="modal-close-btn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="new-chat-form">
                <p class="modal-intro">Enter the email address of the user you want to chat with.</p>

                <div class="form-group">
                    <label for="new-chat-email">User's Email</label>
                    <input type="email" id="new-chat-email" class="modal-input" required>
                </div>

                <p id="new-chat-error" class="modal-error"></p>

                <div class="modal-actions">
                    <button type="button" id="cancel-new-chat-btn" class="modal-btn secondary">Cancel</button>
                    <button type="submit" class="modal-btn primary">Start Chat</button>
                </div>
            </form>
        </div>
    </div>
    <!-- --- END: New Chat Modal --- -->
    <!-- --- START: Confirm Logout Modal --- -->
    <div id="confirm-logout-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Confirm Sign Out</h3>
                <button id="close-logout-modal-btn" class="modal-close-btn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <p class="modal-intro">Are you sure you want to sign out?</p>
            <div class="modal-actions">
                <button type="button" id="cancel-logout-btn" class="modal-btn secondary">Cancel</button>
                <button type="button" id="confirm-logout-btn" class="modal-btn primary-danger">
                    <i class="fas fa-sign-out-alt"></i> Yes, Sign Out
                </button>
            </div>
        </div>
    </div>
    <!-- --- END: Confirm Logout Modal --- -->

    <!-- --- START: NEW Verify Email Modal --- -->
    <div id="verify-otp-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Check Your Email</h3>
            </div>
            <form id="verify-otp-form">
                <p class="modal-intro">
                    We sent a 6-digit confirmation code to:
                    <br>
                    <strong id="otp-email-display">...your-email...</strong>
                    <br><br>
                    Please enter the code below to continue.
                </p>

                <div class="form-group">
                    <label for="otp-input">Verification Code</label>
                    <input type="text" id="otp-input" class="modal-input" required maxlength="6" pattern="\d{6}"
                        title="Please enter a 6-digit code.">
                </div>

                <p id="otp-error" class="modal-error"></p>

                <div class="modal-actions">
                    <button type="submit" class="modal-btn primary">Verify and Log In</button>
                </div>

                <p class="auth-toggle">
                    <button type="button" id="resend-otp-btn" class="auth-toggle-btn">Resend Code</button>
                </p>
            </form>
        </div>
    </div>
    <!-- --- END: NEW Verify Email Modal --- -->

    <script src="config.js"></script>
    <script type="module" src="app.js"></script>
</body>

</html>