<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat UI</title>
    <link rel="stylesheet" href="styles.css">
    <script src="script.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://kit.fontawesome.com/dda2710b56.js" crossorigin="anonymous"></script>
</head>

<body class="auth-visible">

    <div id="auth-overlay">
        <div id="auth-container">
            <!-- Login Form -->
            <form id="login-form">
                <h2>Login</h2>
                <div class="auth-form-group">
                    <label for="login-email">Email</label>
                    <input type="email" id="login-email" class="auth-input" required>
                </div>
                <div class="auth-form-group password-group">
                    <label for="login-password">Password</label>
                    <input type="password" id="login-password" class="auth-input" required>
                    <button type="button" class="password-toggle-btn" id="toggle-login-password"><i
                            class="fa-solid fa-eye"></i></button>
                </div>
                <button type="submit" class="auth-button">Login</button>
                <p class="auth-error" id="login-error"></p>
                <p class="auth-toggle">
                    Don't have an account? <button type="button" id="show-signup-btn" class="auth-toggle-btn">Sign
                        Up</button>
                </p>
            </form>

            <!-- Signup Form (hidden by default) -->
            <form id="signup-form" style="display: none;">
                <h2>Sign Up</h2>
                <div class="auth-form-group">
                    <label for="signup-email">Email</label>
                    <input type="email" id="signup-email" class="auth-input" required>
                </div>
                <div class="auth-form-group password-group">
                    <label for="signup-password">Password (min. 6 characters)</label>
                    <input type="password" id="signup-password" class="auth-input" required>
                    <button type="button" class="password-toggle-btn" id="toggle-signup-password"><i
                            class="fa-solid fa-eye"></i></button>
                </div>
                <button type="submit" class="auth-button">Sign Up</button>
                <p class="auth-error" id="signup-error"></p>
                <p class="auth-toggle">
                    Already have an account? <button type="button" id="show-login-btn"
                        class="auth-toggle-btn">Login</button>
                </p>
            </form>
        </div>
    </div>
    <!-- --- END: Auth Overlay --- -->

    <main class="chat-app">
        <nav class="icon-nav">
            <ul>
                <li><button title="Menu"><i class="fa-solid fa-bars"></i></button></li>
                <li><button title="Profile"><i class="fa-regular fa-user"></i></button></li>
                <li><button title="Messages"><i class="fa-regular fa-message"></i></button></li>
                <li><button title="Settings"><i class="fa-solid fa-gear"></i></button></li>
                <li><button title="Edit"><i class="fa-regular fa-pen-to-square"></i></button></li>
                <li><button title="Sign Out" id="sign-out-btn"><i
                            class="fa-solid fa-arrow-right-from-bracket"></i></button>
                </li>
            </ul>
        </nav>

        <aside class="contacts-panel">
            <header>
                <h2>Chats</h2>
                <span>‚òÖ</span>
            </header>

            <div id="user-info">
                <p>You are logged in as:</p>
                <strong id="user-email-display">...loading...</strong>
            </div>

            <button title="New Chat" id="new-chat-btn" class="contacts-header-btn">
                <i class="fas fa-plus"></i>
            </button>

            <ul class="contacts-list">
                <li class="active">
                    <figure class="avatar"></figure>
                    <div class="contact-info">
                        <strong>John Doe</strong>
                    </div>
                    <time>Today</time>
                </li>
                <li>
                    <figure class="avatar"></figure>
                    <div class="contact-info">
                        <strong>Alice Wen</strong>
                    </div>
                    <time>Today</time>
                </li>
                <li>
                    <figure class="avatar"></figure>
                    <div class="contact-info">
                        <strong>Jacob Will</strong>
                    </div>
                    <time>Today</time>
                </li>
                <li>
                    <figure class="avatar"></figure>
                    <div class="contact-info">
                        <strong>Sarah Kim</strong>
                    </div>
                    <time>Yesterday</time>
                </li>
                <li>
                    <figure class="avatar"></figure>
                    <div class="contact-info">
                        <strong>Mike Ross</strong>
                    </div>
                    <time>Yesterday</time>
                </li>
                <li>
                    <figure class="avatar"></figure>
                    <div class="contact-info">
                        <strong>Eva Williams</strong>
                    </div>
                    <time>10/25</time>
                </li>
            </ul>
        </aside>

        <section class="chat-panel">
            <header>
                <figure class="avatar"></figure>
                <strong>John Doe</strong>
                <div class="chat-controls">
                    <span class="search-icon">üîç</span>
                    <div class="dropdown-container">
                        <button class="dropdown-toggle" title="More options">‚ãÆ</button>
                        <div class="dropdown-menu">
                            <ul>
                                <li><button class="dropdown-item">Clear chat</button></li>
                                <li><button class="dropdown-item">Export chat</button></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </header>
            <div class="messages-area">
                <div class="message received">
                    <p>Hi...</p>
                </div>
                <div class="message received">
                    <p>How are you?</p>
                </div>
                <div class="message sent">
                    <p>I am fine...</p>
                </div>
                <div class="message sent">
                    <p>What about you?</p>
                </div>
            </div>
            <footer>
                <button title="Send">‚û§</button>
                <input type="text" placeholder="message...">
            </footer>
        </section>

    </main>

    <!-- --- START: New Chat Modal --- -->
    <div id="new-chat-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Start a New Chat</h3>
                <button id="close-modal-btn" class="modal-close-btn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="new-chat-form">
                <p class="modal-intro">Enter the email address of the user you want to chat with.</p>

                <div class="form-group">
                    <label for="new-chat-email">User's Email</label>
                    <input type="email" id="new-chat-email" class="modal-input" required>
                </div>

                <p id="new-chat-error" class="modal-error"></p>

                <div class="modal-actions">
                    <button type="button" id="cancel-new-chat-btn" class="modal-btn secondary">Cancel</button>
                    <button type="submit" class="modal-btn primary">Start Chat</button>
                </div>
            </form>
        </div>
    </div>
    <!-- --- END: New Chat Modal --- -->

    <!-- --- START: Confirm Logout Modal --- -->
    <div id="confirm-logout-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Confirm Sign Out</h3>
                <button id="close-logout-modal-btn" class="modal-close-btn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <p class="modal-intro">Are you sure you want to sign out?</p>
            <div class="modal-actions">
                <button type="button" id="cancel-logout-btn" class="modal-btn secondary">Cancel</button>
                <button type="button" id="confirm-logout-btn" class="modal-btn primary-danger">
                    <i class="fas fa-sign-out-alt"></i> Yes, Sign Out
                </button>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script type="module">
        // --- STEP 1: INITIALIZE SUPABASE ---

        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        console.log('Supabase is connected!', db);

        let currentUserId = null;

        // --- STEP 2: GET DOM ELEMENTS ---
        // We need to get all the HTML elements we just created
        const authOverlay = document.getElementById('auth-overlay');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const showSignupBtn = document.getElementById('show-signup-btn');
        const showLoginBtn = document.getElementById('show-login-btn');
        const loginError = document.getElementById('login-error');
        const signupError = document.getElementById('signup-error');
        const chatApp = document.querySelector('.chat-app'); // Get the main app container
        const loginPasswordInput = document.getElementById('login-password');
        const signupPasswordInput = document.getElementById('signup-password');
        const toggleLoginPasswordBtn = document.getElementById('toggle-login-password');
        const toggleSignupPasswordBtn = document.getElementById('toggle-signup-password');
        const userEmailDisplay = document.getElementById('user-email-display');
        const newChatBtn = document.getElementById('new-chat-btn');
        const newChatModal = document.getElementById('new-chat-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const cancelNewChatBtn = document.getElementById('cancel-new-chat-btn');
        const newChatForm = document.getElementById('new-chat-form');
        const newChatError = document.getElementById('new-chat-error');
        const signOutBtn = document.getElementById('sign-out-btn');
        const confirmLogoutModal = document.getElementById('confirm-logout-modal');
        const closeLogoutModalBtn = document.getElementById('close-logout-modal-btn');
        const cancelLogoutBtn = document.getElementById('cancel-logout-btn');
        const confirmLogoutBtn = document.getElementById('confirm-logout-btn');

        // --- STEP 3: HANDLE AUTH LOGIC ---

        // Toggle between login and signup forms
        showSignupBtn.addEventListener('click', () => {
            loginForm.style.display = 'none';
            signupForm.style.display = 'block';
        });

        showLoginBtn.addEventListener('click', () => {
            loginForm.style.display = 'block';
            signupForm.style.display = 'none';
        });

        const togglePassword = (input, button) => {
            if (input.type === 'password') {
                input.type = 'text';
                button.textContent = 'üôà'; // "See-no-evil" monkey for "hide"
            } else {
                input.type = 'password';
                button.textContent = 'üëÅÔ∏è'; // "Eye" for "show"
            }
        };

        // Add click listeners for both password toggle buttons
        toggleLoginPasswordBtn.addEventListener('click', () => {
            togglePassword(loginPasswordInput, toggleLoginPasswordBtn);
        });

        toggleSignupPasswordBtn.addEventListener('click', () => {
            togglePassword(signupPasswordInput, toggleSignupPasswordBtn);
        });

        // Handle Sign Out
        // Handle Sign Out
        signOutBtn.addEventListener('click', () => {
            // Now, instead of logging out, just open the modal
            openLogoutModal();
        });

        // Handle Sign Up
        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;

            // 1. Sign up the user in Supabase Auth
            const { data: authData, error: authError } = await db.auth.signUp({ email, password });

            if (authError) {
                signupError.textContent = authError.message;
                signupError.style.display = 'block';
                console.error('Signup Error:', authError.message);
                return;
            }

            // 2. ALSO add them to your public 'profiles' table
            const { error: profileError } = await db.from('profiles').insert({
                id: authData.user.id,
                email: email
            });

            if (profileError) {
                signupError.textContent = 'Failed to create profile: ' + profileError.message;
                signupError.style.display = 'block';
                console.error('Profile Error:', profileError.message);
            } else {
                console.log('User signed up and profile created!');
                // Log them in immediately (Supabase often does this, but good to be sure)
                // The onAuthStateChange listener will handle hiding the overlay.
            }
        });

        // Handle Login
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            const { data, error } = await db.auth.signInWithPassword({ email, password });

            if (error) {
                loginError.textContent = error.message;
                loginError.style.display = 'block';
                console.error('Login Error:', error.message);
            } else {
                console.log('User logged in:', data.user.email);
                // The onAuthStateChange listener (below) will hide the overlay
            }
        });

        // Helper function to open the modal
        function openNewChatModal() {
            newChatModal.classList.add('show');
            // Clear any previous errors
            newChatError.textContent = '';
            newChatError.style.display = 'none';
            // Reset the form
            newChatForm.reset();
        }

        // Helper function to close the modal
        function closeNewChatModal() {
            newChatModal.classList.remove('show');
        }

        // 1. Open the modal when the '+' button is clicked
        newChatBtn.addEventListener('click', () => {
            openNewChatModal();
        });

        // 2. Close the modal with the 'X' button
        closeModalBtn.addEventListener('click', () => {
            closeNewChatModal();
        });

        // 3. Close the modal with the 'Cancel' button
        cancelNewChatBtn.addEventListener('click', () => {
            closeNewChatModal();
        });

        // 4. Handle the form submission
        // 4. Handle the form submission
        newChatForm.addEventListener('submit', async (e) => {
            e.preventDefault(); // Stop the form from reloading the page

            // --- START: New logic ---
            const emailToChat = document.getElementById('new-chat-email').value;
            const loggedInUserEmail = userEmailDisplay.textContent; // We get your email from the display

            // Clear any previous errors
            newChatError.textContent = '';
            newChatError.style.display = 'none';

            // Check 1: Is the user trying to chat with themselves?
            if (emailToChat === loggedInUserEmail) {
                newChatError.textContent = "For now, you can't start a chat with yourself.";
                newChatError.style.display = 'block';
                return; // Stop the function
            }

            // Check 2: Did the user type anything?
            if (!emailToChat) {
                newChatError.textContent = "Please enter an email address.";
                newChatError.style.display = 'block';
                return; // Stop the function
            }

            console.log(`Trying to find user: ${emailToChat}`);

            // --- This is where we will add Part 3 (database query) ---

            // For now, let's just log it and not close the modal
            // closeNewChatModal();
            // --- END: New logic ---
        });

        // --- END: NEW CHAT MODAL LOGIC ---

        // --- START: LOGOUT CONFIRM LOGIC ---

        // Helper function to open the logout modal
        function openLogoutModal() {
            confirmLogoutModal.classList.add('show');
        }

        // Helper function to close the logout modal
        function closeLogoutModal() {
            confirmLogoutModal.classList.remove('show');
        }

        // 1. Close the modal with the 'X' button
        closeLogoutModalBtn.addEventListener('click', () => {
            closeLogoutModal();
        });

        // 2. Close the modal with the 'Cancel' button
        cancelLogoutBtn.addEventListener('click', () => {
            closeLogoutModal();
        });

        // 3. Handle the FINAL logout click
        confirmLogoutBtn.addEventListener('click', async () => {
            console.log('Signing out...');
            const { error } = await db.auth.signOut();

            if (error) {
                console.error('Error signing out:', error.message);
            } else {
                console.log('User signed out successfully.');
                // The onAuthStateChange listener will handle everything else
            }

            // Always close the modal after
            closeLogoutModal();
        });

        // --- END: LOGOUT CONFIRM LOGIC ---

        // --- STEP 4: MANAGE SESSION ---
        // Important : This listener will automatically trigger on page load and checks if the user is already logged in.

        db.auth.onAuthStateChange((event, session) => {
            if (session) {
                // User is LOGGED IN
                console.log('Auth state changed: User is IN', session.user.email);
                // Hide the login overlay
                authOverlay.classList.add('hidden');
                document.body.classList.remove('auth-visible');
                // Show the main chat app (we'll un-hide it, just in case)
                chatApp.classList.remove('hidden');
                userEmailDisplay.textContent = session.user.email;
                currentUserId = session.user.id;
                // This is where we will load the user's chats next
                // loadUserChats(session.user.id); 

            } else {
                // User is LOGGED OUT
                console.log('Auth state changed: User is OUT');
                // Show the login overlay
                authOverlay.classList.remove('hidden');
                document.body.classList.add('auth-visible');
                // Hide the main chat app
                chatApp.classList.add('hidden');
                currentUserId = null;
            }
        });

    </script>
</body>

</html>